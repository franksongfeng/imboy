

## 消息确认机制 QoS
https://blog.csdn.net/Jessechanrui/article/details/88399012

socket 数据粘包问题、拆包问题

## 消息投递机制

1. 判断用户是否在线，如果用户离线，直接存储离线消息
2. 用户在线（or 用户上线），判断 erlang is_process_alive(Pid) 马上投递一次
3. 没有收到消息之前， 2 S -> 5 S -> 7S -> 11 S 投递4次
4. 如果收到消息 清理定时器，清理数据库消息
5. 4次投递都未确认消息，待用户下次登录再投递

以上消息确认重复机制，可以确保消息不丢失

## WebSocket 链接token校验机制

为提升用户体验，在“WebSocket 链接”的时候，即使token过期也响应成功；
为安全，补救措施如下：
* 在校验token过期有，给客户端发送S2C消息，要求客户端在8秒内（[0,3000,5000]）刷新本token，告知服务端结果
* 在确认刷新token成功后，取消计时器；
* 否则直接给特定链接踢下线

下面是服务端调试代码
```
Uid = 513242,
DID = <<"C5931370-BDCC-55FE-AB9C-8E2B39DC5018">>,
MsgId = <<"please_refresh_token">>,
ToUid = imboy_hashids:uid_encode(Uid),
Msg = message_ds:assemble_msg(
    <<"S2C">>, <<>>, ToUid
    , [{<<"msg_type">>, MsgId}]
    , MsgId),
Msg2 = jsone:encode(Msg, [native_utf8]).

Fun = fun() ->
    Li = imboy_session:list_by_uid(Uid),
    [Pid ! {close, 4006, <<"token invalid, please login again.">>} || {Pid, {_DType1, DID1}} <- Li, DID1 == DID]
end.

message_ds:send_next(Uid, MsgId, Msg2, [3000, 5000, Fun], [DID], true).
```

## 用户通过WS服务链接成功
* ./imboy/src/websocket_handler.erl
	* line 70 user_logic:online/4
* ./imboy/src/user_logic.erl
	* line 28  syn:join/4
	* line 33 user_server:cast_online/3

用户所有的在线设备
用户所有加入的群组

##
